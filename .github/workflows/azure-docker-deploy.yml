name: Deploy to Azure with Docker

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: diabetes-predictor-ai
  AZURE_RESOURCE_GROUP: diabetes-predictor-rg
  IMAGE_NAME: diabetes-predictor
  NODE_VERSION: '20'

jobs:
  build-frontend:
    name: Build React Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install and build frontend
        run: |
          cd frontend
          npm ci --prefer-offline --no-audit
          npm run build
          
      - name: Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 1

  build-and-deploy:
    name: Build Docker Image and Deploy
    runs-on: ubuntu-latest
    needs: [build-frontend]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./static/app

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Azure Container Registry
        id: acr-setup
        run: |
          echo "üì¶ Setting up Azure Container Registry..."
          
          LOCATION="centralindia"
          REGISTRY_NAME="diabetesacr$(date +%s | tail -c 6)"
          
          echo "Creating registry: $REGISTRY_NAME in $LOCATION"
          
          az acr create \
            --name $REGISTRY_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --location $LOCATION \
            --sku Basic \
            --admin-enabled true \
            || echo "Registry might already exist, continuing..."
          
          # Export for next steps
          echo "REGISTRY_NAME=$REGISTRY_NAME" >> $GITHUB_ENV
          echo "registry=$REGISTRY_NAME" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Registry ready: $REGISTRY_NAME"

      - name: Build and Push Docker Image
        env:
          REGISTRY_NAME: ${{ steps.acr-setup.outputs.registry }}
        run: |
          echo "üê≥ Building and pushing Docker image..."
          
          # Login to ACR
          az acr login --name $REGISTRY_NAME
          
          # Build with caching
          docker build \
            --tag $REGISTRY_NAME.azurecr.io/${{ env.IMAGE_NAME }}:latest \
            --tag $REGISTRY_NAME.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            .
          
          # Push both tags
          docker push $REGISTRY_NAME.azurecr.io/${{ env.IMAGE_NAME }}:latest
          docker push $REGISTRY_NAME.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
          
          echo "‚úÖ Image pushed: $REGISTRY_NAME.azurecr.io/${{ env.IMAGE_NAME }}:latest"

      - name: Configure Web App Container
        env:
          REGISTRY_NAME: ${{ steps.acr-setup.outputs.registry }}
        run: |
          echo "‚öôÔ∏è Configuring Web App..."
          
          # Get ACR credentials
          ACR_USERNAME=$(az acr credential show --name $REGISTRY_NAME --query "username" -o tsv)
          ACR_PASSWORD=$(az acr credential show --name $REGISTRY_NAME --query "passwords[0].value" -o tsv)
          
          # Configure container
          az webapp config container set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --docker-custom-image-name $REGISTRY_NAME.azurecr.io/${{ env.IMAGE_NAME }}:latest \
            --docker-registry-server-url https://$REGISTRY_NAME.azurecr.io \
            --docker-registry-server-user $ACR_USERNAME \
            --docker-registry-server-password $ACR_PASSWORD
          
          echo "‚úÖ Container configured"

      - name: Configure App Settings
        run: |
          echo "üîß Setting environment variables..."
          
          az webapp config appsettings set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --settings \
              GROQ_API_KEY="${{ secrets.GROQ_API_KEY }}" \
              FIREBASE_DATABASE_URL="${{ secrets.FIREBASE_DATABASE_URL }}" \
              SECRET_KEY="${{ secrets.SECRET_KEY }}" \
              FLASK_ENV="production" \
              PYTHONUNBUFFERED="1" \
              PYTHONDONTWRITEBYTECODE="1" \
              WEBSITES_ENABLE_APP_SERVICE_STORAGE="false" \
              WEBSITES_PORT="8000" \
              DOCKER_ENABLE_CI="true" \
              WEBSITES_CONTAINER_START_TIME_LIMIT="600"
          
          # Clear startup command (use Docker CMD)
          az webapp config set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --startup-file ''
          
          echo "‚úÖ Settings configured"

      - name: Restart and Deploy
        run: |
          echo "üîÑ Restarting application..."
          
          az webapp restart \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}
          
          echo "‚úÖ Deployment triggered"

      - name: Wait for Deployment
        run: |
          echo "‚è≥ Waiting for application to start (90 seconds)..."
          sleep 90

      - name: Verify Deployment
        run: |
          echo "üîç Verifying deployment..."
          
          APP_URL="https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
          
          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $APP_URL || echo "000")
            echo "Attempt $i: HTTP $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
              echo "‚úÖ Application is live at $APP_URL"
              exit 0
            fi
            
            sleep 10
          done
          
          echo "‚ö†Ô∏è Application may still be starting. Check logs at:"
          echo "az webapp log tail --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }}"
          
      - name: Show Logs on Failure
        if: failure()
        run: |
          echo "‚ùå Deployment verification failed. Fetching logs..."
          az webapp log tail \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            || echo "Could not fetch logs"
