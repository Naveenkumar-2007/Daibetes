name: Deploy to Azure with Docker

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: diabetes-predictor-ai
  AZURE_RESOURCE_GROUP: diabetes-predictor-rg
  REGISTRY_NAME: diabetesacr${{ github.run_number }}
  IMAGE_NAME: diabetes-predictor
  NODE_VERSION: '20'

jobs:
  build-frontend:
    name: Build React Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install and build frontend
        run: |
          cd frontend
          npm ci --prefer-offline --no-audit
          npm run build
          
      - name: Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 1

  build-and-deploy:
    name: Build Docker Image and Deploy
    runs-on: ubuntu-latest
    needs: [build-frontend]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./static/app

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Azure Container Registry (if not exists)
        run: |
          echo "üì¶ Setting up Azure Container Registry..."
          
          # Get resource group location
          LOCATION=$(az group show --name ${{ env.AZURE_RESOURCE_GROUP }} --query location -o tsv)
          echo "Using location: $LOCATION"
          
          # Use a simpler registry name
          REGISTRY_NAME="diabetesacr$(date +%s | tail -c 6)"
          echo "Registry name: $REGISTRY_NAME"
          
          # Create registry
          az acr create \
            --name $REGISTRY_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --location $LOCATION \
            --sku Basic \
            --admin-enabled true
          
          echo "REGISTRY_NAME=$REGISTRY_NAME" >> $GITHUB_ENV
          echo "‚úÖ Registry created: $REGISTRY_NAME"

      - name: Build and push Docker image
        run: |
          echo "üê≥ Building Docker image..."
          
          # Login to ACR
          az acr login --name $REGISTRY_NAME
          
          # Build image
          docker build -t $REGISTRY_NAME.azurecr.io/${{ env.IMAGE_NAME }}:latest .
          
          # Push image
          docker push $REGISTRY_NAME.azurecr.io/${{ env.IMAGE_NAME }}:latest
          
          echo "‚úÖ Image pushed successfully"

      - name: Configure Web App for Container
        run: |
          echo "‚öôÔ∏è Configuring Web App to use Docker container..."
          
          # Get ACR credentials
          ACR_USERNAME=$(az acr credential show --name $REGISTRY_NAME --query "username" -o tsv)
          ACR_PASSWORD=$(az acr credential show --name $REGISTRY_NAME --query "passwords[0].value" -o tsv)
          
          # Configure app to use container
          az webapp config container set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --docker-custom-image-name $REGISTRY_NAME.azurecr.io/${{ env.IMAGE_NAME }}:latest \
            --docker-registry-server-url https://$REGISTRY_NAME.azurecr.io \
            --docker-registry-server-user $ACR_USERNAME \
            --docker-registry-server-password $ACR_PASSWORD
          
          # Set app settings
          az webapp config appsettings set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --settings \
              WEBSITES_ENABLE_APP_SERVICE_STORAGE=false \
              WEBSITES_PORT=8080 \
              DOCKER_ENABLE_CI=true

      - name: Restart Web App
        run: |
          echo "üîÑ Restarting Web App..."
          az webapp restart \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}
          echo "‚úÖ Deployment completed"

      - name: Verify deployment
        run: |
          echo "üîç Waiting for app to start..."
          sleep 60
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net || echo "000")
          echo "HTTP Status: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "‚úÖ Application is running!"
          else
            echo "‚ö†Ô∏è Application may still be starting..."
          fi
